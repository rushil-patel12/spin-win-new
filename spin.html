<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spin & Win</title>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Segoe UI', sans-serif;
  min-height: 100vh;
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

h1 {
  color: #ffd700;
  font-size: 36px;
  margin-bottom: 30px;
}

.wheel-container {
  position: relative;
  width: 320px;
  height: 320px;
}

.wheel {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: conic-gradient(
    #ff6b6b 0deg 60deg,
    #4ecdc4 60deg 120deg,
    #45b7d1 120deg 180deg,
    #96ceb4 180deg 240deg,
    #ffeaa7 240deg 300deg,
    #dfe6e9 300deg 360deg
  );
  border: 8px solid #ffd700;
  transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
}

.labels span {
  position: absolute;
  left: 50%;
  top: 50%;
  transform-origin: center;
  font-weight: bold;
  font-size: 18px;
  color: #000;
}

.pointer {
  position: absolute;
  top: -20px;
  left: 50%;
  transform: translateX(-50%);
  border-left: 20px solid transparent;
  border-right: 20px solid transparent;
  border-top: 40px solid red;
  z-index: 10;
}

button {
  margin-top: 40px;
  padding: 18px 50px;
  font-size: 20px;
  font-weight: bold;
  border: none;
  border-radius: 50px;
  background: linear-gradient(135deg, #ffd700, #ffed4a);
  cursor: pointer;
}

button:disabled {
  background: #666;
}

#result {
  margin-top: 30px;
  font-size: 28px;
  color: #ffd700;
  min-height: 40px;
}
</style>
</head>

<body>

<h1>ðŸŽ° Spin & Win ðŸŽ°</h1>

<div class="wheel-container">
  <div class="pointer"></div>

  <div class="wheel" id="wheel">
   <div class="labels">
  <span style="transform: rotate(0deg) translateY(-110px) rotate(0deg);">â‚¹10</span>
  <span style="transform: rotate(60deg) translateY(-110px) rotate(-60deg);">â‚¹30</span>
  <span style="transform: rotate(120deg) translateY(-110px) rotate(-120deg);">â‚¹50</span>
  <span style="transform: rotate(180deg) translateY(-110px) rotate(-180deg);">â‚¹100</span>
  <span style="transform: rotate(240deg) translateY(-110px) rotate(-240deg);">â‚¹200</span>
  <span style="transform: rotate(300deg) translateY(-110px) rotate(-300deg);">â‚¹500</span>
</div>
  </div>
</div>

<button onclick="spinWheel()" id="spinBtn">SPIN NOW!</button>
<div id="result"></div>

<!-- SOUND FILES -->
<audio id="spinSound" src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3"></audio>
<audio id="winSound" src="https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3"></audio>

<script type="module">
import { db } from "./firebase.js";
import { doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ===========================
   ðŸŽ¯ CHANGE WIN PERCENTAGE HERE
   Total = 100 recommended
   =========================== */

const prizes = [
  { text: "â‚¹10", weight: 60 },   // 60%
  { text: "â‚¹30", weight: 15 },   // 15%
  { text: "â‚¹50", weight: 10 },   // 10%
  { text: "â‚¹100", weight: 7 },   // 7%
  { text: "â‚¹200", weight: 5 },   // 5%
  { text: "â‚¹500", weight: 3 }    // 3%
];

/* =========================== */

let isSpinning = false;
let currentRotation = 0;

function getWeightedIndex() {
  const totalWeight = prizes.reduce((sum, p) => sum + p.weight, 0);
  let random = Math.random() * totalWeight;

  for (let i = 0; i < prizes.length; i++) {
    if (random < prizes[i].weight) return i;
    random -= prizes[i].weight;
  }
  return 0;
}

window.spinWheel = async function () {

  if (isSpinning) return;
  isSpinning = true;

  const button = document.getElementById("spinBtn");
  const wheel = document.getElementById("wheel");
  const result = document.getElementById("result");
  const spinSound = document.getElementById("spinSound");
  const winSound = document.getElementById("winSound");

  button.disabled = true;

  const code = sessionStorage.getItem("validCode");

  if (!code) {
    alert("No valid code!");
    window.location.href = "index.html";
    return;
  }

  try {

    await updateDoc(doc(db, "codes", code), {
      used: true
    });

    result.innerHTML = "Spinning...";
    spinSound.play();

    const segmentAngle = 360 / prizes.length;
    const selectedIndex = getWeightedIndex();

    const extraSpins = 5 * 360;
    const stopAngle = (selectedIndex * segmentAngle) + (segmentAngle / 2);

    currentRotation += extraSpins + (360 - stopAngle);
    wheel.style.transform = `rotate(${currentRotation}deg)`;

    setTimeout(() => {
      spinSound.pause();
      winSound.play();
      result.innerHTML = "ðŸŽ‰ You won: " + prizes[selectedIndex].text;
      sessionStorage.removeItem("validCode");
      isSpinning = false;
    }, 4000);

  } catch (error) {
    alert("Code already used!");
    sessionStorage.removeItem("validCode");
    window.location.href = "index.html";
  }
};
</script>

</body>
</html>
